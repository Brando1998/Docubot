name: Deploy to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Ensure the project directory exists and is a git repository
            if [ ! -d "/home/ubuntu/docubot" ]; then
              echo "Cloning repository..."
              git clone https://github.com/${{ github.repository }} /home/ubuntu/docubot
              cd /home/ubuntu/docubot
            else
              cd /home/ubuntu/docubot
              if [ ! -d ".git" ]; then
                echo "Directory exists but not a git repo, re-cloning..."
                cd ..
                rm -rf docubot
                git clone https://github.com/${{ github.repository }} docubot
                cd docubot
              else
                echo "Pulling latest changes..."
                git pull origin main
              fi
            fi
            echo "Stopping existing services..."
            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            docker container prune -f || true
            make ENV=prod up-local
