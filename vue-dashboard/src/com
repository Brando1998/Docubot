import { ref } from "vue";
import api from "../services/api";

interface BotInstance {
  id: number;
  name: string;
  port: number;
  status: string;
  whatsapp_number: string;
  based_on_bot_id: number;
  created_at: string;
}

export function useBots() {
  const bots = ref<BotInstance[]>([]);
  const isLoading = ref(false);
  const error = ref<string | null>(null);

  const fetchBots = async () => {
    isLoading.value = true;
    error.value = null;
    try {
      const response = await api.get("/api/v1/bot-instances");
      bots.value = response.data || [];
    } catch (err: any) {
      error.value = err.response?.data?.error || "Error cargando bots";
      console.error("Error fetching bots:", err);
    } finally {
      isLoading.value = false;
    }
  };

  const createBot = async (data: {
    name: string;
    whatsapp_number: string;
    based_on_bot_id?: number;
  }) => {
    isLoading.value = true;
    error.value = null;
    try {
      const response = await api.post("/api/v1/bot-instances", data);
      await fetchBots();
      return response.data;
    } catch (err: any) {
      error.value = err.response?.data?.error || "Error creando bot";
      throw err;
    } finally {
      isLoading.value = false;
    }
  };

  const deleteBot = async (id: number) => {
    isLoading.value = true;
    error.value = null;
    try {
      await api.delete(`/api/v1/bot-instances/${id}`);
      await fetchBots();
    } catch (err: any) {
      error.value = err.response?.data?.error || "Error eliminando bot";
      throw err;
    } finally {
      isLoading.value = false;
    }
  };

  return {
    bots,
    isLoading,
    error,
    fetchBots,
    createBot,
    deleteBot,
  };
}
